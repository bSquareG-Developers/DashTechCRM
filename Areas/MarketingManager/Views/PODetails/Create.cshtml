@model DashTechCRM.Models.PODetail
@using DashTechCRM.Models

@{ ViewBag.Title = "New PO";
    Layout = "~/Views/Shared/_Layout.cshtml";
    dashTech_crm_Entities db = new dashTech_crm_Entities(); }

<style>
    .modal-big {
        max-width: 80%;
    }
</style>
<div class="row">
    <div class="col-xl-12">
        <div class="card">
            <div class="card-body">
                <div style="color: #f16c69; cursor: pointer;"
                     data-toggle="collapse"
                     href="#collapseTitle"
                     role="button"
                     aria-expanded="true"
                     aria-controls="collapseTitle">
                    <i class="fa fa-filter"></i> Remaining Po's :
                    <i class="fa fa-plus float-right" style="color: #f16c69; cursor: pointer;"></i>
                </div>
                <hr />
                <div id="collapseTitle" class="collapse show">
                    <div class="row">
                        <div class="col-xl-12">
                            <h4 class="mt-0 header-title mb-4">Remaining Po's :</h4>
                            <div class="rowCount" id="rowCount"></div>
                            <div id="gridContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="modalPODetails" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="modalPODetails" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-big">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title mt-0">Po Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-xl-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">

                                    <div class="col-xl-12 border-right">
                                        <h4 class="mt-0 header-title mb-4">Add New PO</h4>
                                        @using (Html.BeginForm())
                                        {

                            <div class="form-horizontal">
                                <hr />

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">PO Date</lable>
                                            <div class="col-md-10">
                                                <input type="date" name="PODate" id="PODate" class="form-control" required />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Joining Date</lable>
                                            <div class="col-md-10">
                                                <input type="date" name="JoiningDate" id="JoiningDate" class="form-control" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Candidate Name</lable>
                                            <div class="col-md-10">
                                                <select class="form-group select2" id="CandidateId" name="CandidateId" required>
                                                    <option value=""></option>
                                                    @foreach (CandidateMaster item in db.CandidateMasters.ToList())
                                                    {
                                    <option value="@item.CandidateId">@item.CandidateName</option>}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Lead Of</lable>

                                            <div class="col-md-10">
                                                <select class="form-group select2" id="RefOfCandidate" name="RefOfCandidate" required>
                                                    <option value=""></option>
                                                    @foreach (UserAccountDetail item in db.UserAccountDetails.ToList())
                                                    {
                                    <option value="@item.RocketName">@item.FullName</option>}
                                                    <option value="LinkedIn">LinkedIn</option>
                                                    <option value="LinkedIn">Malav</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Sales Assocaite</lable>

                                            <div class="col-md-10">
                                                <select class="form-group select2" id="RefSaleId" name="RefSaleId" required>
                                                    <option value=""></option>


                                                    @foreach (UserAccountDetail item in db.UserAccountDetails.Where(a => a.RefRoleId == 11).ToList())
                                                    {
                                    <option value="@item.UserId">@item.FullName</option>}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Job Type</lable>
                                            <div class="col-md-10">
                                                <input type="text" name="JobType" id="JobType" class="form-control" required />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">

                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Applied Position</lable>

                                            <div class="col-md-10">
                                                <input type="text" name="AppliedPosition" id="AppliedPosition" class="form-control" required />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Interview Support</lable>

                                            <div class="col-md-10">
                                                <input type="text" name="InterviewSupport" id="InterviewSupport" class="form-control" required />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Job Location</lable>
                                            <div class="col-md-10">
                                                <input type="text" name="JobLocation" id="JobLocation" class="form-control" required />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">End Client</lable>
                                            <div class="col-md-10">
                                                <textarea name="EndClient" id="EndClient" class="form-control" required></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Vendor</lable>
                                            <div class="col-md-10">
                                                <textarea type="text" name="VendorDetails" id="VendorDetails" class="form-control" required></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Recruiter Name</lable>
                                            <div class="col-md-10">
                                                <select class="form-group select2" id="RecruiterName" name="RecruiterName" required>
                                                    <option value=""></option>
                                                    @foreach (UserAccountDetail item in db.UserAccountDetails.Where(a => a.RefRoleId == 4 || a.RefRoleId == 18 || a.RefRoleId == 22).ToList())
                                                    {
                                    <option value="@item.RocketName">@item.FullName</option>}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Team Lead Name</lable>
                                            <div class="col-md-10">
                                                <select class="form-group select2" id="TeamLeadName" name="TeamLeadName" required>
                                                    <option value=""></option>
                                                    @foreach (UserAccountDetail item in db.UserAccountDetails.Where(a => a.RefRoleId == 3 || a.RefRoleId == 4).ToList())
                                                    {
                                    <option value="@item.RocketName">@item.FullName</option>}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Rate ($ Per Hr.)</lable>
                                            <div class="col-md-10">
                                                <input type="number" name="Rate" id="Rate" min="0" class="form-control" required />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Sign Up Date</lable>
                                            <div class="col-md-10">
                                                <input type="date" name="SignUpDate" id="SignUpDate" class="form-control" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Trainer Name</lable>
                                            <div class="col-md-10">
                                                <input type="text" name="TrainerName" id="TrainerName" class="form-control" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Training Start Date</lable>
                                            <div class="col-md-10">
                                                <input type="date" name="TrainingStartDate" id="TrainingStartDate" class="form-control" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Training End Date</lable>
                                            <div class="col-md-10">
                                                <input type="date" name="TrainingEndDate" id="TrainingEndDate" class="form-control" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Marketing Start Date</lable>
                                            <div class="col-md-10">
                                                <input type="date" name="MarketingStartDate" id="MarketingStartDate" class="form-control" required />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Marketing End Date</lable>
                                            <div class="col-md-10">
                                                <input type="date" name="MarketingEndDate" id="MarketingEndDate" class="form-control" required />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Agreement Per (%)</lable>
                                            <div class="col-md-10">
                                                <input type="number" name="AgreementPercentage" id="AgreementPercentage" class="form-control" required />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Agreement Months</lable>

                                            <div class="col-md-10">
                                                <select class="form-group select2" id="AgreementMonths" name="AgreementMonths" required>
                                                    <option value=""></option>
                                                    @for (int i = 2; i <= 12; i++)
                                                    {
                                    <option value="@string.Format("{0}",i)">@string.Format("{0} Months", i)</option>}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Job Description</lable>

                                            <div class="col-md-10">
                                                <textarea name="JobDescription" class="form-control" required></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <lable class="control-label col-md-2">Other Details</lable>
                                            <div class="col-md-10">
                                                <textarea name="OtherDetails" class="form-control" required></textarea>

                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <input type="submit" value="Create" class="btn btn-primary btn-block" />
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div>
                                            @Html.ActionLink("Back to List", "Index")
                                        </div>
                                    </div>
                                </div>
                            </div>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<script>

    $('[data-mask]').inputmask();
    $('.select2').select2();
    $(function() {
        BindRemainingPos();
    });

    function BindRemainingPos() {
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: "@Url.Action("GetRemainingPODetails")",
            success: function (response) {
                response = JSON.parse(response);

                var dataGrid = $("#gridContainer").dxDataGrid({
                    dataSource: response,
                    columns: [
                        {
                            dataField: 'PODetails', caption: 'PO Details', alignment: 'center', dataType: 'string', width: 100, format: '', type: 'buttons', cellTemplate: function (container, options) {
                                jQuery('<span class="fa fa-plus" style:"cursor:pointer">').text('').on('dxclick', function () {
                                    AddPoDetails(options.data);
                                }).appendTo(container);

                            }
                        },
                        { dataField: 'CandidateName', caption: 'Candidate Name', alignment: 'center', dataType: 'string', width: 120, format: '' },
                        { dataField: 'JoiningDate', caption: 'Joining Date', alignment: 'center', dataType: 'date', width: 150, format: 'dd MMM yyyy' },
                        { dataField: 'SalesAssociateName', caption: 'Sales Associate Name', alignment: 'center', dataType: 'string', width: 150, format: '' },
                        { dataField: 'RequiredLocationList', caption: 'Required Location List', alignment: 'center', dataType: 'string', width: 200, format: '' },
                        { dataField: 'TeamLeadName', caption: 'Team Lead Name', alignment: 'center', dataType: 'string', width: 150, format: '' },
                        { dataField: 'RecruiterName', caption: 'Recruiter Name', alignment: 'center', dataType: 'string', width: 150, format: '' },
                        { dataField: 'MarketingStartDate', caption: 'Marketing Start Date', alignment: 'center', dataType: 'string', width: 150, format: 'dd MMM yyyy'},
                        { dataField: 'Agreement', caption: 'Agreement', alignment: 'center', dataType: 'string', width: 150, format: '' },
                        { dataField: 'RePaymentMonths', caption: 'Agreement Months', alignment: 'center', dataType: 'string', width: 130, format: '' }
                    ],
                    columnsAutoWidth: true,
                    wordWrapEnabled: true,
                    rowAlternationEnabled: true,
                    showBorders: true,
                    grouping: { autoExpandAll: true },
                    paging: { pageSize: 10 },
                    pager: { showPageSizeSelector: true, allowedPageSizes: [5, 10, 15, 20] },
                    headerFilter: { visible: true },
                    filterRow: { visible: true, applyFilter: "auto" },
                    allowColumnResizing: true,
                    export: {
                        enabled: true,
                        fileName: "Remaining Po Details",
                        allowExportSelectedData: true,
                        customizeExcelCell: options => {
                            if (options.gridCell.rowType === "header") {
                                options.backgroundColor = _dxGridHeaderBGColor;
                                options.font.color = _dxGridHeaderColor;
                            }
                        }
                    },
                    selection: { mode: "multiple" },
                    columnFixing: { enabled: false },
                    onCellPrepared: function(e) {
                        if (e.rowType === "header") {
                            e.cellElement.css("text-align", "center");
                            e.cellElement.css("font-weight", "bold");
                        }
                        if (e.rowType === "group") {
                            e.cellElement.css("text-align", "center");
                        }
                    },
                    onContentReady(e) {
                        jQuery('#rowCount').html('Total Records : ' + jQuery("#gridContainer").dxDataGrid('instance').totalCount());
                    }
                }).dxDataGrid('instance');

            }
        });
    }

    function AddPoDetails(data) {
        param = { candidateId: data.CandidateId}
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: "@Url.Action("GetRemainingPoDetailsByCandidateId")",
            data: "{parameter:'" + JSON.stringify(param) + "'}",
            success: function (data) {
                data = JSON.parse(data);
                if (data.length > 0) {
                    console.log(data);

                    $('#JoiningDate').val(new Date(data[0].JoiningDate).toISOString().split('T')[0]);
                    $('#CandidateId').val(data[0].CandidateId);
                    $('#RefSaleId').val(data[0].SalesAssociateId);
                    $('#AppliedPosition').val(data[0].TechTitle);
                    $('#JobLocation').val(data[0].RequiredLocationList);
                    $('#RecruiterName').val(data[0].RecruiterRocket);
                    $('#TeamLeadName').val(data[0].TeamLeadRocket); // remaining
                    $('#MarketingStartDate').val(new Date(data[0].MarketingStartDate).toISOString().split('T')[0]);
                    $('#AgreementPercentage').val(data[0].Agreement);
                    $('#AgreementMonths').val(data[0].RePaymentMonths);
                }
            }
        });

        $('#modalPODetails').modal({ backdrop: 'static', keyboard: false });
    }
</script>
